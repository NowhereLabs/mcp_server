<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/ws.js"></script>
    <link rel="stylesheet" href="/static/css/output.css">
</head>
<body class="h-full bg-gray-50">
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <h1 class="text-3xl font-bold text-gray-900">MCP Server Dashboard</h1>
                <div class="text-sm text-gray-500 font-medium">v{{ version }}</div>
            </div>
        </div>
    </header>
    
    <main class="flex-1">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Server Status Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Server Status</h2>
                    <div id="status-content"
                         hx-get="/api/status"
                         hx-trigger="load, every 2s"
                         hx-swap="innerHTML">
                        <div class="text-gray-500 animate-pulse">Loading...</div>
                    </div>
                </div>
                
                <!-- Metrics Grid -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Performance Metrics</h2>
                    <div id="metrics-content"
                         hx-get="/api/metrics"
                         hx-trigger="load, every 5s"
                         hx-swap="innerHTML">
                        <div class="text-gray-500 animate-pulse">Loading...</div>
                    </div>
                </div>
                
                <!-- Available Tools -->
                <div class="card lg:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Available Tools</h2>
                    <div id="tools-content"
                         hx-get="/api/tools"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="text-gray-500 animate-pulse">Loading...</div>
                    </div>
                </div>
                
                <!-- Recent Tool Calls -->
                <div class="card lg:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Tool Calls</h2>
                    <div id="tool-calls-content"
                         hx-get="/api/tool-calls"
                         hx-trigger="load, every 3s"
                         hx-swap="innerHTML">
                        <div class="text-gray-500 animate-pulse">Loading...</div>
                    </div>
                </div>
                
                <!-- Live Events Stream -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Live Events</h2>
                    <div id="events-content"
                         hx-ext="sse"
                         sse-connect="/sse"
                         sse-swap="message">
                        <div id="events-stream" class="h-64 overflow-y-auto scrollbar-thin bg-gray-50 rounded p-3">
                            <div class="text-gray-500 text-sm">Waiting for events...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Handle SSE events
        document.body.addEventListener('htmx:sseMessage', function(evt) {
            try {
                const data = JSON.parse(evt.detail.data);
                const eventsStream = document.getElementById('events-stream');
                
                const eventItem = document.createElement('div');
                eventItem.className = 'text-sm p-2 rounded mb-1 font-mono';
                
                if (data.type === 'error') {
                    eventItem.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                } else if (data.type === 'tool_called') {
                    eventItem.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                }
                
                const timestamp = new Date(data.timestamp).toLocaleTimeString();
                let message = `[${timestamp}] ${data.type}`;
                
                if (data.name) {
                    message += `: ${data.name}`;
                }
                if (data.message) {
                    message += `: ${data.message}`;
                }
                if (data.uri) {
                    message += `: ${data.uri}`;
                }
                
                eventItem.textContent = message;
                eventsStream.insertBefore(eventItem, eventsStream.firstChild);
                
                // Keep only last 50 events
                while (eventsStream.children.length > 50) {
                    eventsStream.removeChild(eventsStream.lastChild);
                }
            } catch (error) {
                console.error('Error parsing SSE message:', error);
            }
        });
        
        // Tool execution function
        function executeTool(toolName) {
            // Get default arguments for each tool
            const defaultArgs = getDefaultArguments(toolName);
            
            // For demo purposes, use default arguments
            // In a real application, you'd want to show a form to input arguments
            const requestData = {
                name: toolName,
                arguments: defaultArgs
            };
            
            // Disable the button during execution
            const button = document.querySelector(`button[data-tool="${toolName}"]`);
            if (button) {
                button.disabled = true;
                button.textContent = 'Executing...';
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            fetch('/api/tools/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Tool executed successfully!\\nResult: ${JSON.stringify(data.result, null, 2)}`);
                } else {
                    alert(`Tool execution failed:\\n${data.error}`);
                }
                
                // Re-enable the button
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Execute';
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // Refresh tool calls to show the new execution
                document.getElementById('tool-calls-content').dispatchEvent(new Event('htmx:trigger'));
            })
            .catch(error => {
                alert(`Error executing tool: ${error.message}`);
                
                // Re-enable the button
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Execute';
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
        
        // Get default arguments for each tool (for demo purposes)
        function getDefaultArguments(toolName) {
            switch (toolName) {
                case 'read_file':
                    return { path: '/etc/hostname' };
                case 'write_file':
                    return { path: '/tmp/test.txt', content: 'Hello from dashboard!' };
                case 'list_directory':
                    return { path: '/tmp' };
                case 'http_get':
                    return { url: 'https://httpbin.org/get' };
                case 'http_post':
                    return { url: 'https://httpbin.org/post', data: { test: 'data' } };
                case 'system_info':
                    return {};
                default:
                    return {};
            }
        }
        
        // Custom response handlers
        document.body.addEventListener('htmx:beforeSwap', function(evt) {
            if (evt.detail.target.id === 'status-content') {
                const response = JSON.parse(evt.detail.xhr.response);
                const statusClass = response.server.connected ? 'connected' : 'disconnected';
                const statusText = response.server.connected ? 'Connected' : 'Disconnected';
                
                evt.detail.target.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <span class="inline-block w-3 h-3 rounded-full ${response.server.connected ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-sm font-medium ${response.server.connected ? 'text-green-700' : 'text-red-700'}">${statusText}</span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <p class="flex justify-between">
                                <span class="font-medium">Server:</span>
                                <span>${response.server.server_info.name} v${response.server.server_info.version}</span>
                            </p>
                            <p class="flex justify-between">
                                <span class="font-medium">Capabilities:</span>
                                <span class="text-right">${response.server.capabilities.join(', ')}</span>
                            </p>
                            <p class="flex justify-between">
                                <span class="font-medium">Active Sessions:</span>
                                <span class="font-mono">${response.runtime.active_sessions}</span>
                            </p>
                        </div>
                    </div>
                `;
                evt.detail.shouldSwap = false;
            }
            
            if (evt.detail.target.id === 'metrics-content') {
                const response = JSON.parse(evt.detail.xhr.response);
                
                evt.detail.target.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-gray-900">${response.tool_calls.total}</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Total Tool Calls</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-gray-900">${response.tool_calls.success_rate.toFixed(1)}%</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Success Rate</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-gray-900">${response.sessions.active}</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Active Sessions</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-2xl font-bold text-gray-900">${response.tool_calls.avg_duration_ms.toFixed(0)}ms</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Avg Duration</div>
                        </div>
                    </div>
                `;
                evt.detail.shouldSwap = false;
            }
            
            if (evt.detail.target.id === 'tools-content') {
                const tools = JSON.parse(evt.detail.xhr.response);
                let html = '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">';
                
                tools.forEach(tool => {
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">${tool.name}</h3>
                            <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mb-2">
                                ${tool.category}
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${tool.description}</p>
                            <button class="execute-tool-btn w-full bg-blue-600 text-white text-sm font-medium py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" data-tool="${tool.name}">
                                Execute
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
                evt.detail.target.innerHTML = html;
                evt.detail.shouldSwap = false;
                
                // Add click handlers to execute buttons
                document.querySelectorAll('.execute-tool-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const toolName = this.dataset.tool;
                        executeTool(toolName);
                    });
                });
            }
            
            if (evt.detail.target.id === 'tool-calls-content') {
                const calls = JSON.parse(evt.detail.xhr.response);
                
                if (calls.length === 0) {
                    evt.detail.target.innerHTML = '<p class="text-gray-500 text-sm">No tool calls yet...</p>';
                } else {
                    let html = '<div class="space-y-2 max-h-64 overflow-y-auto">';
                    calls.forEach(call => {
                        const timestamp = new Date(call.timestamp).toLocaleString();
                        const isSuccess = call.result && call.result.Success;
                        const isError = call.result && call.result.Error;
                        const isPending = !call.result;
                        
                        const statusBg = isSuccess ? 'bg-green-50 border-green-200' : 
                                       isError ? 'bg-red-50 border-red-200' : 
                                       'bg-yellow-50 border-yellow-200';
                        const statusIcon = isSuccess ? '✓' : isError ? '✗' : '○';
                        const statusColor = isSuccess ? 'text-green-600' : 
                                          isError ? 'text-red-600' : 
                                          'text-yellow-600';
                        const duration = call.duration_ms ? `${call.duration_ms}ms` : 'pending';
                        
                        html += `
                            <div class="${statusBg} border rounded-lg p-3 transition-all hover:shadow-sm">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="${statusColor} text-lg font-bold">${statusIcon}</span>
                                        <span class="font-medium text-gray-900">${call.name}</span>
                                    </div>
                                    <span class="text-sm font-mono text-gray-600">${duration}</span>
                                </div>
                                <div class="text-xs text-gray-500">${timestamp}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    evt.detail.target.innerHTML = html;
                }
                evt.detail.shouldSwap = false;
            }
        });
    </script>
</body>
</html>